# CLAUDE.md

Ce fichier fournit des instructions √† Claude Code (claude.ai/code) pour travailler sur ce d√©p√¥t.

## Commandes de D√©veloppement

**Gestionnaire de paquets :** Ce projet utilise pnpm par d√©faut. Utiliser `pnpm` au lieu de `npm` :

**Serveur de d√©veloppement :**

```bash
pnpm dev
```

**Build et aper√ßu :**

```bash
pnpm build
pnpm preview
```

**Qualit√© du code :**

```bash
pnpm lint      # V√©rification Prettier + ESLint
pnpm format    # Formatage avec Prettier
pnpm check     # Type checking avec Svelte
```

**V√©rification qualit√© compl√®te :**

```bash
/quality-check  # Commande slash : Lint + Format + Check en une seule fois
```

La commande `/quality-check` ex√©cute les 3 v√©rifications (`lint`, `format`, `check`) et g√©n√®re un rapport structur√© des erreurs.

**Tests :**

```bash
pnpm test:unit    # Ex√©cuter les tests Vitest
pnpm test         # Ex√©cuter les tests une fois
```

**Op√©rations base de donn√©es :**

**Base CENOV (Principale - Production) :**

```bash
pnpm prisma:generate                        # G√©n√©rer client Prisma (cenov)
pnpm prisma:migrate                        # Ex√©cuter migrations base de donn√©es (cenov)
pnpm prisma:studio                         # Ouvrir Prisma Studio (cenov)
pnpm prisma:push                          # Pousser sch√©ma vers base de donn√©es (cenov)
pnpm prisma:pull                          # R√©cup√©rer sch√©ma depuis base de donn√©es (cenov)
```

**Base CENOV_DEV (D√©veloppement) :**

```bash
pnpm prisma:generate-dev                   # G√©n√©rer client Prisma (cenov_dev)
pnpm prisma:migrate-dev                    # Ex√©cuter migrations (cenov_dev)
pnpm prisma:studio-dev                     # Ouvrir Prisma Studio (cenov_dev)
pnpm prisma:push-dev                       # Pousser sch√©ma vers BDD (cenov_dev)
pnpm prisma:pull-dev                       # R√©cup√©rer sch√©ma depuis BDD (cenov_dev)
```

**G√©n√©rer les deux clients :**

```bash
pnpm prisma:generate-all                   # G√©n√©rer les deux clients (automatique au pnpm install)
```

**Commandes manuelles (si n√©cessaire) :**

```bash
# CENOV:
npx prisma generate --schema prisma/cenov/schema.prisma
npx prisma db push --schema prisma/cenov/schema.prisma
npx prisma db pull --schema prisma/cenov/schema.prisma
npx prisma studio --schema prisma/cenov/schema.prisma
npx prisma migrate dev --schema prisma/cenov/schema.prisma
npx prisma migrate deploy --schema prisma/cenov/schema.prisma

# CENOV_DEV:
npx prisma generate --schema prisma/cenov_dev/schema.prisma
npx prisma db push --schema prisma/cenov_dev/schema.prisma
npx prisma db pull --schema prisma/cenov_dev/schema.prisma
npx prisma studio --schema prisma/cenov_dev/schema.prisma
npx prisma migrate dev --schema prisma/cenov_dev/schema.prisma
npx prisma migrate deploy --schema prisma/cenov_dev/schema.prisma
```

**Installation des d√©pendances :**

```bash
pnpm install              # Installer toutes les d√©pendances
pnpm add <package>        # Ajouter une d√©pendance
pnpm add -D <package>     # Ajouter une d√©pendance de dev
```

**Scripts BDD-IA (Export base de donn√©es) :**

```bash
node scripts/BDD-IA/fetch-all-tables.mjs    # Exporter toutes les tables
node scripts/BDD-IA/fetch-all-views.mjs     # Exporter toutes les vues
node scripts/BDD-IA/fetch-cenov-data.mjs    # Tout exporter (recommand√©)
```

_Exporte toutes les donn√©es Cenov en lecture seule vers des fichiers JSON dans `scripts/BDD-IA/output/`_

**Scripts DMMF (M√©tadonn√©es Prisma) :**

```bash
node scripts/Script\ DMMF/extract-dmmf-metadata.mjs    # Extraire m√©tadonn√©es DMMF
```

_Extrait les m√©tadonn√©es Prisma DMMF (Data Model Meta Format) de CENOV_DEV vers `scripts/Script DMMF/output/` - 8 fichiers optimis√©s pour diff√©rents usages_

**Fichiers DMMF g√©n√©r√©s :**

1. **quick-stats.json** (~60 lignes) - Aper√ßu rapide structure DB
2. **models-index.json** (~150 lignes) - Navigation mod√®les avec d√©pendances
3. **relations-graph.json** (~200 lignes) - Graphe complet relations FK
4. **import-order.json** (~120 lignes) - Ordre d'import optimal (tri topologique)
5. **validation-rules.json** (~400 lignes) - R√®gles validation par champ
6. **native-types.json** (~80 lignes) - Mapping Prisma ‚Üî PostgreSQL
7. **summary-dmmf.json** (~100 lignes) - Statistiques essentielles
8. **full-dmmf.json** (~13 580 lignes) - DMMF complet brut (r√©f√©rence technique)

**üìñ Documentation compl√®te :** Voir `scripts/Script DMMF/output/README.md` pour guide d'utilisation d√©taill√©, cas d'usage et exemples

## Vue d'Ensemble de l'Architecture

### Stack Technique

- **Frontend:** SvelteKit avec TypeScript
- **Version Svelte:** **Svelte 5** (utiliser en priorit√© : `$state`, `$derived`, `$effect`, `$props`)
- **Base de donn√©es:** PostgreSQL avec Prisma ORM
- **Styles:** TailwindCSS avec composants Flowbite et Shadcn Svelte
- **Authentification:** Int√©gration Logto
- **Traitement fichiers:** Capacit√©s d'import XLSX
- **Tests:** Vitest avec Testing Library

### Architecture Base de Donn√©es

**Architecture Double Base :**

L'application utilise **DEUX bases de donn√©es s√©par√©es** :

1. **Base CENOV** (`DATABASE_URL`) - Base principale de production
   - Syst√®me principal de gestion des produits, kits et pi√®ces
   - **12 tables** (568 lignes totales) : 7 sch√©ma `produit` (368 lignes) + 5 sch√©ma `public` (200 lignes)
   - **Sch√©ma produit** : categorie, categorie_attribut, cross_ref, famille, produit, produit_categorie, tarif_achat
   - **Sch√©ma public** : attribut, fournisseur, kit, kit_attribute, part_nc
   - **6 vues** (1685 lignes totales) : 3 sch√©ma `produit` (916 lignes) + 3 sch√©ma `public` (769 lignes)
   - **Vues produit** : v_produit_categorie_attribut, v_tarif_achat, mv_categorie
   - **Vues public** : v_categorie, v_kit_caracteristique, v_produit_categorie_attribut

2. **Base CENOV_DEV** (`CENOV_DEV_DATABASE_URL`) - Base d√©veloppement √©tendue
   - Catalogue produits √©tendu et gestion fournisseurs avanc√©e
   - **15 tables** (572 lignes totales) : 7 sch√©ma `produit` (371 lignes) + 8 sch√©ma `public` (201 lignes)
   - **Sch√©ma produit** : category, category_attribute, cross_ref, family, price_purchase, product, product_category
   - **Sch√©ma public** : attribute, attribute_value, document, document_link, kit, kit_attribute, part_nc, supplier
   - **8 vues** (1791 lignes totales) : 4 sch√©ma `produit` (1015 lignes) + 4 sch√©ma `public` (776 lignes)
   - **Vues produit** : import_name, v_produit_categorie_attribut, v_tarif_achat, mv_categorie
   - **Vues public** : attribute_required, v_categorie, v_kit_caracteristique, v_produit_categorie_attribut

**Export base de donn√©es:** Donn√©es compl√®tes export√©es en JSON dans `scripts/BDD-IA/output/` pour analyse IA :

- **CENOV** : 12 tables (568 lignes), 6 vues (1685 lignes)
- **CENOV_DEV** : 15 tables (572 lignes), 8 vues (1791 lignes)

## Principe Anti-Hardcoding avec Prisma DMMF

**R√àGLE :** Toujours v√©rifier si un hardcoding peut √™tre remplac√© par des m√©tadonn√©es Prisma DMMF.

```typescript
// ‚ùå MAUVAIS - Hardcoding de donn√©es DB
const databases = ['cenov', 'cenov_dev'];
if (dbName !== 'cenov' && dbName !== 'cenov_dev') throw new Error('BDD inconnue');
if (database === 'cenov') return 1;

// ‚úÖ BON - Utiliser Prisma DMMF
const databases = await getAllDatabaseNames();
if (!validDatabases.includes(dbName)) throw new Error(`BDD inconnue`);
return a.database.localeCompare(b.database);

// ‚úÖ OK - Config UI acceptable
export const DATABASE_CONFIG = { cenov: { icon: RocketIcon, variant: 'bleu' } };
const schema = metadata.schema || 'public'; // Standard SQL
```

**Fonctions DMMF :** `getAllDatabaseNames()`, `getTableMetadata()`, `getAllDatabaseTables()`

**R√®gle :** Donn√©es DB ‚Üí Prisma DMMF | UI/Config ‚Üí Fichier centralis√©

### Utilisation Client Prisma

**Importer le bon client :**

```typescript
// Pour la base CENOV (principale):
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

// Pour la base CENOV_DEV:
import { PrismaClient as CenovDevPrismaClient } from '../../prisma/cenov_dev/generated';
const cenovDevPrisma = new CenovDevPrismaClient();

// Exemples d'utilisation:
const kits = await prisma.kit.findMany(); // Base CENOV
const products = await cenovDevPrisma.produit.findMany(); // Base CENOV_DEV
```

**Gestion des Connexions :**

- CENOV: Client Prisma standard pour op√©rations principales
- CENOV_DEV: Client s√©par√© pour fonctionnalit√©s catalogue produits
- Les deux bases peuvent √™tre utilis√©es simultan√©ment

### Structure des Fichiers Cl√©s

- `src/routes/` - Pages SvelteKit (categories, kits, import, products)
- `src/lib/components/` - Composants Svelte r√©utilisables incluant biblioth√®que UI
- `src/lib/schemas/dbSchema.ts` - Sch√©mas de validation Zod pour toutes les entit√©s
- `src/lib/prisma-meta.ts` - Utilitaires centralis√©s m√©tadonn√©es Prisma
- `prisma/cenov/schema.prisma` - Sch√©ma base de donn√©es principal

### Utilitaires Prisma Meta

**`src/lib/prisma-meta.ts`** fournit des fonctions centralis√©es de m√©tadonn√©es via Prisma DMMF (Data Model Meta Format) :

**Fonctions Principales :**

- `getDatabases()` - Acc√®s aux clients et m√©tadonn√©es des deux bases
- `getTableMetadata(database, tableName)` - D√©tection sch√©ma via DMMF
- `getAllTables(database)` - Tables avec d√©tection automatique du sch√©ma
- `getAllDatabaseTables()` - Tables combin√©es des deux bases

**Bonnes Pratiques :**

- **√âviter le hardcoding** - Utiliser m√©tadonn√©es Prisma DMMF au lieu de valeurs hardcod√©es
- D√©tection sch√©ma: Utiliser `metadata.schema` depuis `getTableMetadata()`
- Listes de tables: Utiliser `getAllTables()` au lieu de noms hardcod√©s
- Infos base: Utiliser propri√©t√©s DMMF au lieu de comparaisons de cha√Ænes
- D√©tection dynamique pr√©f√©r√©e aux listes statiques pour la maintenabilit√©

### Workflow Prisma

**Workflow Double Sch√©ma :**

**Pour la base CENOV (principale) :**

1. √âditer `prisma/cenov/schema.prisma`
2. Ex√©cuter: `npx prisma generate --schema prisma/cenov/schema.prisma`
3. Ex√©cuter: `npx prisma db push --schema prisma/cenov/schema.prisma` (ou migrate)

**Pour la base CENOV_DEV :**

1. √âditer `prisma/cenov_dev/schema.prisma`
2. Ex√©cuter: `npx prisma generate --schema prisma/cenov_dev/schema.prisma`
3. Ex√©cuter: `npx prisma db push --schema prisma/cenov_dev/schema.prisma` (ou migrate)

**‚ö†Ô∏è Probl√®mes Courants & Solutions :**

- **Erreur "Model already exists":** Toujours sp√©cifier le flag `--schema` pour √©viter les conflits
- **Conflits de g√©n√©ration:** Ne jamais ex√©cuter `prisma generate` sans flag `--schema`
- **Mauvais client import√©:** V√©rifier les chemins d'import - utiliser les clients g√©n√©r√©s depuis les bons r√©pertoires

**Corrections rapides :**

```bash
# Nettoyer et r√©g√©n√©rer les deux clients:
rm -rf prisma/generated/ node_modules/.prisma/
npx prisma generate --schema prisma/cenov/schema.prisma
npx prisma generate --schema prisma/cenov_dev/schema.prisma
```

### Authentification

Utilise Logto pour l'authentification avec :

- Routes prot√©g√©es via `src/lib/auth/protect.ts`
- Gestion session utilisateur dans les layouts
- Gestion callback pour flux OAuth

### Syst√®me d'Import

Fonctionnalit√© d'import de fichiers Excel pour :

- Cat√©gories et attributs
- Hi√©rarchies de kits et caract√©ristiques
- Localis√© dans les routes `/import` et `/products/import`

### Tests

Les tests d'int√©gration couvrent :

- Op√©rations CRUD pour cat√©gories et kits
- Fonctionnalit√© d'import
- Localis√©s dans `tests/integration/`

## Notes de D√©veloppement

- Utilise pnpm comme gestionnaire de paquets
- Support des sch√©mas de production et d√©veloppement (tables/vues \_dev)
- Composants UI personnalis√©s construits sur bits-ui et Flowbite
- Validation de formulaires avec sch√©mas Zod et SvelteKit Superforms

## Bonnes Pratiques TypeScript

**√âviter le type `any`** - Pr√©f√©rer des types sp√©cifiques pour √©viter les erreurs @typescript-eslint/no-explicit-any :

```typescript
// ‚ùå MAUVAIS - Utiliser any
const data: any[] = [];
const previewData: Record<string, any[]> = {};

// ‚úÖ BON - Utiliser des types sp√©cifiques
const data: Record<string, unknown>[] = [];
const previewData: Record<string, unknown[]> = {};

// ‚úÖ BON - Utiliser des d√©finitions d'interface
interface TableData {
	id: number;
	name: string;
	[key: string]: unknown; // Pour propri√©t√©s dynamiques
}
const data: TableData[] = [];
```

**Remplacements TypeScript courants :**

- `any[]` ‚Üí `unknown[]` ou `Record<string, unknown>[]`
- `any` ‚Üí `unknown` ou interface sp√©cifique
- `Record<string, any>` ‚Üí `Record<string, unknown>`
- Pour r√©sultats Prisma: utiliser types g√©n√©r√©s ou `Record<string, unknown>`

**Quand utiliser `unknown` :**

- R√©ponses API externes
- Donn√©es dynamiques depuis bases de donn√©es
- Entr√©es utilisateur n√©cessitant validation
- Structures de donn√©es g√©n√©riques

## Guide Composants UI

**Variantes de boutons disponibles :**

- `bleu` (d√©faut) - Bouton bleu principal
- `vert` - Actions succ√®s/confirmation
- `rouge` - Actions danger/suppression
- `jaune` - Actions avertissement
- `noir` - Actions secondaires sombres
- `blanc` - Style alternatif/outline
- `link` - Style lien texte

**Note:** La variante `outline` n'existe pas - utiliser `blanc` pour les boutons style outline.

**Variantes de badges disponibles :**

- `default` (d√©faut) - Style badge principal
- `bleu` - Badge informatif bleu
- `vert` - Badge succ√®s/positif
- `rouge` - Badge erreur/danger
- `noir` - Badge secondaire/neutre
- `blanc` - Style alternatif/outline
- `orange` - Badge modification

**Note:** La variante `outline` n'existe pas pour les badges - utiliser `blanc` pour style outline.

### Int√©gration Ic√¥nes Badge

**IMPORTANT:** Le composant Badge g√®re automatiquement les ic√¥nes SVG avec style int√©gr√© :

```typescript
// ‚úÖ CORRECT - Laisser le composant g√©rer taille et espacement
<Badge variant="vert">
  <Eye />
  Vues
</Badge>

// ‚ùå MAUVAIS - Ne pas ajouter manuellement classes taille/espacement
<Badge variant="vert">
  <Eye class="mr-1 h-3 w-3" />
  Vues
</Badge>
```

**Style Ic√¥ne Badge Int√©gr√© :**

- `[&>svg]:size-3` - Toutes ic√¥nes SVG obtiennent automatiquement `size-3` (12x12px)
- `[&>svg]:pointer-events-none` - Ic√¥nes n'interf√®rent pas avec √©v√©nements clic
- `gap-1` - Espacement automatique entre ic√¥ne et texte
- `items-center justify-center` - Alignement parfait

**Bonne Pratique :** Toujours lire les classes CSS du composant avant d'ajouter style manuel. La plupart des composants UI g√®rent les ic√¥nes nativement.

## Bonnes Pratiques Svelte - Cl√©s dans les Boucles {#each}

### Probl√®me : Erreur `svelte/require-each-key`

**‚ö†Ô∏è Sympt√¥me :** ESLint signale "Each block should have a key" - cause bugs d'affichage et probl√®mes de performance.

**‚úÖ Solution :** Toujours ajouter une cl√© unique

```svelte
<!-- ‚úÖ CORRECT -->
{#each items as item (item.id)}           <!-- ID unique (meilleur) -->
{#each columns as column (column.key)}    <!-- Propri√©t√© unique -->
{#each databases as db (db)}              <!-- Valeur primitive unique -->
{#each rows as row, i (i)}                <!-- Index (dernier recours) -->

<!-- ‚ùå MAUVAIS -->
{#each items as item}                     <!-- Sans cl√© -->
```

**Priorit√© de choix :** ID unique > Propri√©t√© unique > Valeur primitive > Index

**√âviter ce probl√®me √† l'avenir :**
- Toujours ajouter la cl√© d√®s la cr√©ation de la boucle : `{#each items as item (item.id)}`
- V√©rifier avec `/quality-check` avant de commit
- Si h√©sitation, utiliser l'index : `{#each items as item, i (i)}`

**Correction en masse :**
```bash
# Corriger ligne sp√©cifique avec sed
sed -i '113s/{#each columns as column}/{#each columns as column (column.key)}/' src/file.svelte
```

## Notifications Toast (Sonner)

Ce projet utilise **svelte-sonner** pour les notifications toast.

### Pr√©requis

1. **Installation :** D√©j√† install√© comme d√©pendance
2. **Composant Toaster :** Doit √™tre plac√© dans layout racine (`+layout.svelte`)
3. **Import :** Toujours importer directement depuis `'svelte-sonner'`

### Utilisation Correcte

```typescript
// ‚úÖ CORRECT Import
import { toast } from 'svelte-sonner';

// ‚úÖ CORRECT Configuration Toaster (d√©j√† dans +layout.svelte)
import { Toaster } from 'svelte-sonner';
<Toaster position="top-center" richColors={true} />

// ‚úÖ CORRECT Utilisation
toast.error('Message erreur');
toast.success('Message succ√®s');
toast('Message info');
```

### Erreurs Courantes √† √âviter

```typescript
// ‚ùå MAUVAIS - Ne pas importer depuis composants UI
import { toast } from '$lib/components/ui/sonner';

// ‚ùå MAUVAIS - Ne pas utiliser wrapper personnalis√© pour toasts basiques
import { Toaster } from '$lib/components/ui/sonner/sonner.svelte';
```

### Bonnes Pratiques Timing

- **Toasts au chargement page :** Utiliser `setTimeout` avec petit d√©lai (100ms) dans `onMount`
- **Gestionnaires √©v√©nements :** Appeler directement sans d√©lai
- **Apr√®s navigation :** Fonctionne imm√©diatement apr√®s redirections

### Int√©gration Authentification

Le projet a des toasts d'erreur auth int√©gr√©s :

- Routes prot√©g√©es affichent automatiquement toast si acc√®s non autoris√©
- G√©r√© via param√®tres URL et `onMount` dans homepage

## R√©solution Conflits √âdition Fichiers

**Lors d'erreurs "File has been unexpectedly modified" :**

Cela se produit typiquement quand fichiers sont automatiquement format√©s par linters/formatters (Prettier, ESLint) apr√®s lecture.

**√âtapes de r√©solution :**

1. **Utiliser chemins Windows absolus D'ABORD :** Toujours utiliser chemins Windows absolus avec lettres de lecteur et backslashes pour TOUTES op√©rations fichiers :

   ```bash
   # ‚úÖ CORRECT - Utiliser chemins Windows absolus
   C:\Users\EwanSenergous\OneDrive - jll.spear\Bureau\Projet\importData\file.js

   # ‚ùå MAUVAIS - Chemins relatifs ou style Unix peuvent √©chouer
   ./file.js
   /c/Users/.../file.js
   ```

2. **Formater avec Prettier (si conflits persistent) :** Les erreurs viennent souvent du formatage automatique Prettier/TypeScript. Relancer le formatage :

   ```bash
   pnpm format
   ```

3. **Relire avant √©dition :** Toujours utiliser outil Read pour obtenir dernier √©tat fichier apr√®s formatage

4. **Comportement attendu :** Les linters peuvent formater automatiquement, c'est intentionnel et doit √™tre pr√©serv√©

5. **Git restore (derni√®re option seulement) :** Si tous les autres essais √©chouent, restaurer le fichier √† son √©tat original :

   ```bash
   git restore src/path/to/file.svelte
   ```

**Sc√©narios courants :**

- Prettier reformate espacement et sauts de ligne
- ESLint corrige automatiquement probl√®mes de style
- Ces changements sont intentionnels et am√©liorent qualit√© du code

**Bonnes pratiques :**

- **TOUJOURS essayer chemins Windows absolus d'abord** avant toute autre solution
- **Utiliser `pnpm format` ensuite** pour synchroniser le formatage
- Ne pas annuler changements linter sauf demande explicite
- **Git restore est la DERNI√àRE option** - √† utiliser seulement si tout le reste √©choue
- Relire fichiers apr√®s formatage pour obtenir √©tat actuel

**Appliquer chemins Windows absolus √† tous les outils :**

- Outil Read: Toujours utiliser chemins `C:\...`
- Outil Write: Toujours utiliser chemins `C:\...`
- Outil Edit: Toujours utiliser chemins `C:\...`
- Outil MultiEdit: Toujours utiliser chemins `C:\...`

## Debugging Probl√®mes de R√©activit√© Svelte

Cette section documente les techniques pour diagnostiquer et r√©soudre les probl√®mes de r√©activit√© dans Svelte, particuli√®rement lors de la migration vers Svelte 5.

### Probl√®me : Console.log Accidentellement R√©actifs

**‚ö†Ô∏è Sympt√¥me courant :** Une fonctionnalit√© cesse de marcher apr√®s suppression de `console.log` "innocents".

**üîç Diagnostic :**

```typescript
// ‚ùå PROBL√âMATIQUE - console.log maintient accidentellement la r√©activit√©
$: if (condition) {
	someVariable = newValue;
	console.log('Debug:', someVariable); // ‚Üê Force l'√©valuation r√©active !
}

// ‚ùå Quand ce log est supprim√©, la r√©activit√© peut se casser
$: if (condition) {
	someVariable = newValue;
	// La variable peut ne plus √™tre "observ√©e" par Svelte
}
```

**üéØ Techniques de Diagnostic :**

1. **Identifier les logs suspects :**

   ```bash
   # Chercher tous les console.log dans les d√©clarations r√©actives
   grep -n "console\.(log\|warn\|error)" src/routes/export/*.svelte
   ```

2. **V√©rifier les logs dans les d√©clarations r√©actives :**
   - `$: { ... console.log(...) ... }` ‚Üê Suspect
   - `$: console.log(...)` ‚Üê Tr√®s suspect
   - Dans les `$effect(() => { console.log(...) })` ‚Üê OK (informatif)

3. **Tester la th√©orie :**
   - Supprimer temporairement un `console.log` suspect
   - Tester si la fonctionnalit√© se casse
   - Si oui ‚Üí le log maintenait la r√©activit√©

### Solution : Migration Svelte 5 Propre

**‚úÖ Remplacer les hacks r√©actifs par des primitives explicites :**

```typescript
// ‚ùå ANCIEN - Hack avec console.log
$: if (step === 3 && data.length > 0 && !config) {
	config = { ...formData };
	console.log('Config sauv√©e:', config); // ‚Üê Maintient la r√©activit√©
}

// ‚úÖ NOUVEAU - Svelte 5 propre
let config = $state(null);

let shouldSaveConfig = $derived(step === 3 && data.length > 0 && !config);

$effect(() => {
	if (shouldSaveConfig) {
		config = { ...formData };
		console.log('Config sauv√©e:', config); // ‚Üê Informatif seulement
	}
});
```

### Patterns de Migration Svelte 5

**1. Variables d'√âtat :**

```typescript
// ‚ùå Ancien
let state = initialValue;

// ‚úÖ Nouveau
let state = $state(initialValue);
```

**2. Props :**

```typescript
// ‚ùå Ancien
export let data;

// ‚úÖ Nouveau
let { data } = $props();
```

**3. D√©clarations R√©actives :**

```typescript
// ‚ùå Ancien
$: filteredData = data.filter((item) => item.active);

// ‚úÖ Nouveau
let filteredData = $derived(data.filter((item) => item.active));
```

**4. Effets de Bord :**

```typescript
// ‚ùå Ancien
$: {
	if (condition) {
		performSideEffect();
		console.log('Side effect triggered'); // ‚Üê Maintient r√©activit√©
	}
}

// ‚úÖ Nouveau - Effet explicite
$effect(() => {
	if (condition) {
		performSideEffect();
		console.log('Side effect triggered'); // ‚Üê Informatif seulement
	}
});
```

**5. Composants Dynamiques :**

```typescript
// ‚ùå Ancien - Svelte 4
<svelte:component this={getComponent(type)} />

// ‚úÖ Nouveau - Svelte 5
{@const Component = getComponent(type)}
<Component />

// Ou dans les boucles :
{#each items as item}
    {@const ItemComponent = getComponent(item.type)}
    <ItemComponent />
{/each}
```

### Workflow de Diagnostic Complet

**√âtape 1 : Identifier le Probl√®me**

```bash
# Chercher les patterns suspects
grep -rn "console\.log.*\$" src/routes/
grep -rn "\$:.*console" src/routes/
```

**√âtape 2 : Tester l'Hypoth√®se**

- Commenter temporairement les `console.log` suspects
- V√©rifier si la fonctionnalit√© se casse
- Si oui ‚Üí confirmer le probl√®me de r√©activit√© accidentelle

**√âtape 3 : Analyser la R√©activit√©**

```typescript
// Ajouter des logs de debug pour comprendre le flux
$effect(() => {
	console.log('üîÑ Reactive state changed:', stateVariable);
});

$effect(() => {
	console.log('üìä Derived value updated:', derivedValue);
});
```

**√âtape 4 : Migrer vers Svelte 5**

- Remplacer `export let` ‚Üí `$props()`
- Remplacer `let` variables modifi√©es ‚Üí `$state()`
- Remplacer `$:` ‚Üí `$derived` ou `$effect`
- Remplacer `<svelte:component>` ‚Üí `{@const Component}`

**√âtape 5 : V√©rifier la Propret√©**

```bash
# V√©rifier qu'aucun console.log ne d√©clenche plus la r√©activit√©
grep -n "console\.log" src/routes/export/*.svelte

# Les logs restants doivent √™tre soit :
# - Dans des $effect (OK - informatif)
# - Dans des fonctions (OK - informatif)
# - Dans des handlers d'√©v√©nements (OK - informatif)
# - PAS dans des d√©clarations r√©actives directes
```

### Indicateurs de R√©activit√© Propre

**‚úÖ Signes que la r√©activit√© est correcte :**

1. **S√©paration claire :**
   - `$derived` pour les valeurs calcul√©es
   - `$effect` pour les effets de bord
   - `$state` pour les variables modifiables
   - `console.log` uniquement informatifs

2. **Pas de d√©pendance aux logs :**
   - Supprimer tous les `console.log` ne casse rien
   - La logique fonctionne sans les logs de debug

3. **Architecture explicite :**

   ```typescript
   // ‚úÖ R√©activit√© explicite et intentionnelle
   let data = $state([]);
   let filteredData = $derived(data.filter((item) => item.active));
   let count = $derived(filteredData.length);

   $effect(() => {
   	console.log('Data changed, new count:', count); // ‚Üê Informatif
   });
   ```

### Erreurs Communes √† √âviter

**‚ùå Console.log dans d√©clarations r√©actives :**

```typescript
$: if (condition) doSomething() && console.log('done'); // ‚Üê Danger !
```

**‚ùå M√©langer logique et debug :**

```typescript
$: {
	processData();
	console.log('Processing...'); // ‚Üê Peut maintenir r√©activit√©
	updateUI();
}
```

**‚úÖ S√©parer logique et debug :**

```typescript
$effect(() => {
	processData();
	updateUI();
});

$effect(() => {
	console.log('Processing...'); // ‚Üê Debug s√©par√©
});
```

### Outils de V√©rification

**Commandes utiles pour v√©rifier la migration :**

```bash
# V√©rifier les patterns Svelte 5
grep -rn "export let" src/routes/        # Doit √™tre vide apr√®s migration
grep -rn "\$:" src/routes/               # Doit √™tre minimal apr√®s migration
grep -rn "svelte:component" src/routes/  # Doit √™tre vide apr√®s migration

# V√©rifier la r√©activit√© propre
grep -rn "console\.log.*\$" src/routes/  # Ne doit pas exister
grep -rn "\$:.*console" src/routes/      # Ne doit pas exister
```

Cette approche syst√©matique permet de diagnostiquer et r√©soudre efficacement les probl√®mes de r√©activit√© subtils dans Svelte, particuli√®rement lors des migrations vers Svelte 5.
