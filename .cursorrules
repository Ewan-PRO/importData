# R√®gles de d√©veloppement pour ImportData

## Environnement et outils

- Utiliser **pnpm** comme gestionnaire de paquets (jamais npm)
- Stack : SvelteKit + TypeScript + PostgreSQL + Prisma + TailwindCSS
- Authentification via Logto
- Tests avec Vitest

## Commandes essentielles

**D√©veloppement :**

```bash
pnpm dev                  # Serveur de d√©veloppement
pnpm build && pnpm preview  # Build et aper√ßu
pnpm lint && pnpm format  # Qualit√© du code
pnpm check                # V√©rification TypeScript
pnpm test:unit            # Tests unitaires
```

**Prisma - CENOV (Production) :**

```bash
pnpm prisma:generate      # G√©n√©ration client Prisma
pnpm prisma:migrate       # Migrations base de donn√©es
pnpm prisma:studio        # Interface Prisma Studio
pnpm prisma:push          # Push sch√©ma vers BDD
pnpm prisma:pull          # Pull sch√©ma depuis BDD
```

**Prisma - CENOV_DEV (D√©veloppement) :**

```bash
pnpm prisma:generate-dev  # G√©n√©ration client dev
pnpm prisma:migrate-dev   # Migrations dev
pnpm prisma:studio-dev    # Studio dev
pnpm prisma:push-dev      # Push sch√©ma dev
pnpm prisma:pull-dev      # Pull sch√©ma dev
```

**Clients Prisma :**

```bash
pnpm prisma:generate-all  # G√©n√©ration des deux clients
```

**Scripts BDD-IA (Export base de donn√©es) :**

```bash
node scripts/BDD-IA/fetch-all-tables.mjs    # Export toutes les tables
node scripts/BDD-IA/fetch-all-views.mjs     # Export toutes les vues
node scripts/BDD-IA/fetch-cenov-data.mjs    # Export complet (recommand√©)
```

**Scripts DMMF (M√©tadonn√©es Prisma) :**

```bash
node scripts/Script\ DMMF/extract-dmmf-metadata.mjs    # Extraire m√©tadonn√©es DMMF
```

_Extrait m√©tadonn√©es Prisma DMMF de CENOV_DEV : 8 fichiers (quick-stats, models-index, relations-graph, import-order, validation-rules, native-types, summary, full-dmmf)_

**üìñ Documentation compl√®te :** `scripts/Script DMMF/output/README.md` - Guide d√©taill√©, cas d'usage et exemples

## Architecture et fichiers cl√©s

- `src/routes/` : Pages SvelteKit (categories, kits, import, products)
- `src/lib/components/` : Composants r√©utilisables + UI library
- `src/lib/schemas/dbSchema.ts` : Sch√©mas Zod pour validation
- `prisma/cenov/schema.prisma` : Sch√©ma principal base de donn√©es CENOV
- `prisma/cenov_dev/schema.prisma` : Sch√©ma base de donn√©es CENOV_DEV

## Workflow Prisma

1. √âditer `prisma/cenov/schema.prisma` (ou `prisma/cenov_dev/schema.prisma`)
2. Ex√©cuter les commandes Prisma directement sur le sch√©ma principal

## Base de donn√©es

**Architecture double base :**

- **CENOV Database** (`DATABASE_URL`) - Base principale production
- **CENOV_DEV Database** (`CENOV_DEV_DATABASE_URL`) - Base d√©veloppement √©tendue

**Clients Prisma :**

```typescript
// Base CENOV (principale) :
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

// Base CENOV_DEV :
import { PrismaClient as CenovDevPrismaClient } from '../../prisma/cenov_dev/generated';
const cenovDevPrisma = new CenovDevPrismaClient();
```

## Principe Anti-Hardcoding avec Prisma DMMF

**R√àGLE :** Toujours v√©rifier si un hardcoding peut √™tre remplac√© par des m√©tadonn√©es Prisma DMMF.

```typescript
// ‚ùå MAUVAIS - Hardcoding de donn√©es DB
const databases = ['cenov', 'cenov_dev'];
if (dbName !== 'cenov' && dbName !== 'cenov_dev') throw new Error('BDD inconnue');
if (database === 'cenov') return 1;

// ‚úÖ BON - Utiliser Prisma DMMF
const databases = await getAllDatabaseNames();
if (!validDatabases.includes(dbName)) throw new Error(`BDD inconnue`);
return a.database.localeCompare(b.database);

// ‚úÖ OK - Config UI acceptable
export const DATABASE_CONFIG = { cenov: { icon: RocketIcon, variant: 'bleu' } };
const schema = metadata.schema || 'public'; // Standard SQL
```

**Fonctions DMMF :** `getAllDatabaseNames()`, `getTableMetadata()`, `getAllDatabaseTables()`

**R√®gle :** Donn√©es DB ‚Üí Prisma DMMF | UI/Config ‚Üí Fichier centralis√©

**M√©tadonn√©es Prisma :**

- Utiliser `src/lib/prisma-meta.ts` pour m√©tadonn√©es centralis√©es
- √âviter valeurs hardcod√©es, utiliser Prisma DMMF
- Fonctions : `getDatabases()`, `getTableMetadata()`, `getAllTables()`

## Conventions de code

- camelCase pour fonctions et variables
- Typage strict TypeScript - **√âVITER `any`, utiliser `unknown`**
- Programmation fonctionnelle privil√©gi√©e
- async/await plut√¥t que callbacks
- Early returns pour √©viter imbrication
- const/let jamais var
- Template literals plut√¥t que concat√©nation
- Gestion erreurs explicite avec try/catch
- Fonctions pures sans effets de bord
- Principes DRY, KISS, YAGNI

**TypeScript - Remplacements recommand√©s :**

```typescript
// ‚ùå √âviter
const data: any[] = [];
const previewData: Record<string, any[]> = {};

// ‚úÖ Utiliser
const data: unknown[] = [];
const previewData: Record<string, unknown[]> = {};
```

## Authentification

- Routes prot√©g√©es via `src/lib/auth/protect.ts`
- Gestion session dans layouts
- Callback OAuth dans `/authentication-callback`

## Import Excel

- Fonctionnalit√© import dans `/import` et `/products/import`
- Support cat√©gories, attributs, hi√©rarchies kits

## Tests

- Tests d'int√©gration dans `tests/integration/`
- CRUD operations pour categories et kits
- Tests de fonctionnalit√© import

## Composants UI

- Composants personnalis√©s bas√©s sur bits-ui et Flowbite
- Validation formulaires avec Zod + SvelteKit Superforms
- Structure dans `src/lib/components/ui/`

**Button variants :**

- `bleu` (default) - Primary blue button
- `vert` - Success/confirmation actions
- `rouge` - Danger/delete actions
- `jaune` - Warning actions
- `noir` - Secondary dark actions
- `blanc` - Alternative/outline style
- `link` - Text link style

**Note:** `outline` variant n'existe pas - utiliser `blanc` pour style outline.

**Badge variants :**

- `default` (default) - Primary badge style
- `bleu` - Blue informational badge
- `vert` - Success/positive badge
- `rouge` - Error/danger badge
- `noir` - Secondary/neutral badge
- `blanc` - Alternative/outline style badge
- `orange` - Modification badge

**Note:** `outline` variant n'existe pas pour badges - utiliser `blanc` pour style outline.

### Int√©gration Ic√¥nes Badge

**IMPORTANT:** Le composant Badge g√®re automatiquement les ic√¥nes SVG avec style int√©gr√© :

```typescript
// ‚úÖ CORRECT - Laisser le composant g√©rer taille et espacement
<Badge variant="vert">
  <Eye />
  Vues
</Badge>

// ‚ùå MAUVAIS - Ne pas ajouter manuellement classes taille/espacement
<Badge variant="vert">
  <Eye class="mr-1 h-3 w-3" />
  Vues
</Badge>
```

**Style Ic√¥ne Badge Int√©gr√© :**

- `[&>svg]:size-3` - Toutes ic√¥nes SVG obtiennent automatiquement `size-3` (12x12px)
- `[&>svg]:pointer-events-none` - Ic√¥nes n'interf√®rent pas avec √©v√©nements clic
- `gap-1` - Espacement automatique entre ic√¥ne et texte
- `items-center justify-center` - Alignement parfait

**Bonne Pratique :** Toujours lire les classes CSS du composant avant d'ajouter style manuel. La plupart des composants UI g√®rent les ic√¥nes nativement.

## Toast Notifications (Sonner)

**Setup :** svelte-sonner install√©, Toaster configur√© dans +layout.svelte

**Usage correct :**

```typescript
// ‚úÖ Import correct
import { toast } from 'svelte-sonner';
import { Toaster } from 'svelte-sonner';

// ‚úÖ Usage
toast.error("Message d'erreur");
toast.success('Op√©ration r√©ussie');
toast('Message info');
```

**Erreurs √† √©viter :**

```typescript
// ‚ùå N'JAMAIS importer depuis les composants UI
import { toast } from '$lib/components/ui/sonner';
```

### Bonnes Pratiques Timing

- **Toasts au chargement page :** Utiliser `setTimeout` avec petit d√©lai (100ms) dans `onMount`
- **Gestionnaires √©v√©nements :** Appeler directement sans d√©lai
- **Apr√®s navigation :** Fonctionne imm√©diatement apr√®s redirections

### Int√©gration Authentification

Le projet a des toasts d'erreur auth int√©gr√©s :

- Routes prot√©g√©es affichent automatiquement toast si acc√®s non autoris√©
- G√©r√© via param√®tres URL et `onMount` dans homepage

## Debugging R√©activit√© Svelte

**Probl√®me courant :** `console.log` maintiennent accidentellement la r√©activit√© dans Svelte 4.

**Sympt√¥me :** Fonctionnalit√© casse apr√®s suppression de logs "innocents".

### Diagnostic rapide

```bash
# Identifier les logs suspects
grep -n "console\.(log\|warn\|error)" src/routes/export/*.svelte
grep -rn "\$:.*console" src/routes/
```

**Patterns dangereux :**

- `$: { ... console.log(...) ... }` ‚Üê Suspect
- `$: console.log(...)` ‚Üê Tr√®s suspect
- Dans `$effect(() => { console.log(...) })` ‚Üê OK (informatif)

### Migration Svelte 5 (solution)

```typescript
// ‚ùå ANCIEN - Hack r√©actif avec console.log
$: if (step === 3 && data.length > 0 && !config) {
	config = { ...formData };
	console.log('Config sauv√©e:', config); // ‚Üê Force la r√©activit√© !
}

// ‚úÖ NOUVEAU - Svelte 5 propre
let config = $state(null);
let shouldSaveConfig = $derived(step === 3 && data.length > 0 && !config);

$effect(() => {
	if (shouldSaveConfig) {
		config = { ...formData };
		console.log('Config sauv√©e:', config); // ‚Üê Informatif seulement
	}
});
```

### Patterns de migration

```typescript
// Variables d'√©tat
export let data;              ‚Üí let { data } = $props();
let state = value;            ‚Üí let state = $state(value);

// R√©activit√©
$: derived = compute(data);   ‚Üí let derived = $derived(compute(data));
$: { sideEffect(); }         ‚Üí $effect(() => { sideEffect(); });

// Composants dynamiques
<svelte:component this={C} /> ‚Üí {@const Component = C} <Component />
```

### V√©rification post-migration

```bash
# Ces commandes doivent retourner vide apr√®s migration
grep -rn "export let" src/routes/
grep -rn "svelte:component" src/routes/
grep -rn "console\.log.*\$" src/routes/      # Console.log dans r√©activit√©
grep -rn "\$:.*console" src/routes/          # R√©activit√© avec console
```

**R√®gle d'or :** Supprimer tous les `console.log` ne doit jamais casser la logique.

## R√©ponses en fran√ßais

- Toujours r√©pondre en fran√ßais
- √ätre concis, √©viter phrases de remplissage
- Montrer seulement lignes chang√©es avec contexte minimal
- Anticiper besoins et sugg√©rer solutions

## R√©solution Conflits √âdition Fichiers

**Lors d'erreurs "File has been unexpectedly modified" :**

Cela se produit typiquement quand fichiers sont automatiquement format√©s par linters/formatters (Prettier, ESLint) apr√®s lecture.

**√âtapes de r√©solution :**

1. **Utiliser chemins Windows absolus D'ABORD :** Toujours utiliser chemins Windows absolus avec lettres de lecteur et backslashes pour TOUTES op√©rations fichiers :

   ```bash
   # ‚úÖ CORRECT - Utiliser chemins Windows absolus
   C:\Users\EwanSenergous\OneDrive - jll.spear\Bureau\Projet\importData\file.js

   # ‚ùå MAUVAIS - Chemins relatifs ou style Unix peuvent √©chouer
   ./file.js
   /c/Users/.../file.js
   ```

2. **Git restore (si chemins absolus ne fonctionnent pas) :** Si conflits persistent, restaurer le fichier √† son √©tat original :

   ```bash
   git restore path/to/file.svelte
   ```

3. **Relire avant √©dition :** Toujours utiliser outil Read pour obtenir dernier √©tat fichier avant √©dition

4. **Comportement attendu :** Les linters peuvent formater automatiquement, c'est intentionnel et doit √™tre pr√©serv√©

**Sc√©narios courants :**

- Prettier reformate espacement et sauts de ligne
- ESLint corrige automatiquement probl√®mes de style
- Ces changements sont intentionnels et am√©liorent qualit√© du code

**Bonnes pratiques :**

- **TOUJOURS essayer chemins Windows absolus d'abord** avant d'utiliser git restore
- Ne pas annuler changements linter sauf demande explicite
- Utiliser git restore seulement quand chemins absolus et conflits bloquent progression
- Relire fichiers apr√®s formatage pour obtenir √©tat actuel

**Appliquer chemins Windows absolus √† tous les outils :**

- Outil Read: Toujours utiliser chemins `C:\...`
- Outil Write: Toujours utiliser chemins `C:\...`
- Outil Edit: Toujours utiliser chemins `C:\...`
- Outil MultiEdit: Toujours utiliser chemins `C:\...`
